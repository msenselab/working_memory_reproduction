---
title: "PymcRltReport"
author: "Fiona Zhu"
date: "2025-11-13"
output:
   pdf_document:
    latex_engine: xelatex
   html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rlist)
library(ez)
library(tidyverse)
library(latex2exp)
library(lsr)
library(rticles)
library(DescTools)
library(heplots)
library(lme4)
library(rstatix)
library(boot)
library(ggpubr)
library(reshape2)
library(ggplot2)
library(readr)
source('mytheme.R')
```
## Setting

```{r}
modelname = "Experimentwise" # "FreeParameters" 
filepath = paste0("../data/", modelname,"/")
# 设置实验顺序
order_exp <- c("Encoding", "Reproduction", "Baseline", "Both", "Both_gap")
exp_labels <- c(
  "Encoding"     = "Exp. 1\nEncoding",
  "Reproduction" = "Exp. 2\nReproduction",
  "Baseline"     = "Exp. 3\nBaseline",
  "Both"         = "Exp. 4\nBoth",
  "Both_gap"     = "Exp. 5\nBoth (with gap)"
)
Exp.labs.2lines <- c("Exp. 1\nEncoding", "Exp. 2\nReproduction", "Exp. 3\nBaseline", "Exp. 4\nBoth", "Exp. 5\nBoth (with gap)")
```


## Load data

```{r}
mdat_all <- read_csv(paste0(filepath, modelname, "_mdat_all.csv"))
mdat_all$Exp <- factor(mdat_all$Exp, levels = order_exp)
mdat_all$Gap <- factor(mdat_all$Gap, labels = c("short", "long"))
mdat_all$WMSize <- factor(mdat_all$WMSize, labels = c("low", "medium",  "high")) 
```


```{r}
# Here the predicted RP was based on function predict_single_subject
PredRPList <- read_csv(paste0(filepath, modelname, "_PredRPList.csv"))

PredRPList$WMSize <- factor(PredRPList$WMSize, labels = c("low", "medium",  "high")) 
PredRPList$Gap <- factor(PredRPList$Gap, labels = c("short", "long"))

PredRPList$Exp <- factor(PredRPList$Exp, levels = order_exp)
```

## Estimated parameters

```{r}
# 读取数据
ParaList <-  read_csv(paste0(filepath, modelname, "_ParaList.csv"))
ParaList$Gap <- factor(ParaList$Gap, labels = c("short", "long"))
ParaList$Exp <- factor(ParaList$Exp, levels = order_exp)
ParaList$WMSize <- factor(ParaList$WMSize, labels = c("low", "medium",  "high")) 
```

```{r pressure, echo=FALSE}
# 参数名（根据实际列名修改）
params <- c("ks","ls","kr","ts","var_s","mu_p","var_p","var_n")

# 计算每个实验的均值和标准差
df_summary <- ParaList %>%
  pivot_longer(cols = all_of(params), names_to = "Parameter", values_to = "Value") %>%
  group_by(Exp, Parameter) %>%
  summarise(
    Mean = mean(Value, na.rm = TRUE),
    SD = sd(Value, na.rm = TRUE),
    .groups = "drop"
  )

# 绘图
ggplot(df_summary, aes(x = Exp, y = Mean, fill = Exp)) +
  geom_bar(stat = "identity", color = "black", width = 0.7) +
  geom_errorbar(aes(ymin = Mean - SD, ymax = Mean + SD), width = 0.2) +
  facet_wrap(~ Parameter, scales = "free_y", ncol = 4) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    legend.position = "none"
  ) +
  labs(
    title = "Mean ± SD of Parameters by Experiment",
    y = "Mean ± SD",
    x = "Experiment"
  )

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r}
# --- 定义 param_labels 为 named list of expressions
param_labels <- list(
  ks    = expression(k[s]),
  ls    = expression(l[s]),
  kr    = expression(k[r]),
  ts    = expression(t[s]),
  var_s = expression(var[s]),
  mu_p  = expression(mu[p]),
  var_p = expression(var[p]),
  var_n = expression(var[n])
)


# 参数列表
params <- c("ks", "ls", "kr", "ts", "var_s", "mu_p", "var_p", "var_n")

# 计算每个实验各参数的均值与标准误（SE）
df_summary <- ParaList %>%
  pivot_longer(cols = all_of(params), names_to = "Parameter", values_to = "Value") %>%
  group_by(Exp, Parameter) %>%
  summarise(
    Mean = mean(Value, na.rm = TRUE),
    n = sum(!is.na(Value)),
    SD = sd(Value, na.rm = TRUE),
    SE = SD / sqrt(n),
    .groups = "drop"
  )

# 确保 Parameter 的因子顺序与 param_labels 名字一致
df_summary$Parameter <- factor(df_summary$Parameter, levels = names(param_labels))

# 绘图
ggplot(df_summary, aes(x = Exp, y = Mean, group = 1)) +
  geom_line(color = "black", linewidth = 0.7) +
  geom_point(size = 1.8, color = "black") +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE),
                width = 0.15, linewidth = 0.7) +
  facet_wrap(~ Parameter, scales = "free_y", ncol = 4,
             labeller = labeller(Parameter = as_labeller(param_labels))) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +   # 避免 x 轴标签重叠
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    legend.position = "none",
    strip.text = element_text(size = 11)
  ) +
  labs(
    title = "Mean ± SE of Parameters by Experiment",
    x = "Experiment",
    y = "Mean"
  ) +
  theme_new
```
```{r}
# 绘图
ggplot(df_summary, aes(x = Exp, y = Mean, group = Parameter)) +
  geom_line(color = "black", linewidth = 0.7) +
  geom_point(size = 1.5, color = "black") +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE),
                width = 0.15, linewidth = 0.7) +
  facet_wrap(~ Parameter, scales = "free_y", ncol = 4,
             labeller = labeller(Parameter = as_labeller(param_labels, label_parsed))) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    legend.position = "none",
    strip.text = element_text(size = 11)
  ) +
  labs(
    title ="Mean ± SE of Parameters by Experiment",
    x = "Experiment",
    y = "Mean"
  ) +
  theme_new+scale_x_discrete(guide = guide_axis(n.dodge = 1)) +
theme(axis.text.x = element_text(angle = 30, hjust = 1))
```
## predicted bias



```{r}
# Here the predicted RP was based on function predict_newdata_from_posterior

newdat_all <- read_csv(paste0(filepath, modelname, "_newdat_all.csv")) %>%
  filter(!(Exp != "Both_gap" & Gap == 2.5))
newdat_all$cv = newdat_all$sdPred/newdat_all$mPred
newdat_all$Exp <- factor(newdat_all$Exp, levels = order_exp)
newdat_all$Gap <- factor(newdat_all$Gap, labels = c("short", "long"))
newdat_all$WMSize <- factor(newdat_all$WMSize, labels = c("low", "medium",  "high")) 
newdat_all <- newdat_all %>% 
  rename(curDur = xnew)
```


```{r}
RP_bias_bw <- ggplot(data = mdat_all%>% 
                         dplyr::group_by(Exp, curDur, WMSize, Gap) %>% 
                         dplyr::summarize(m_repDur_mean = mean(repDur_mean),  n= n(), se_repDur_mean = sd(repDur_mean)/sqrt(n-1)), 
                      aes(x = curDur, y = m_repDur_mean - curDur, 
                          group = interaction(Gap, WMSize), 
                          color = as.factor(WMSize),
                          shape = as.factor(WMSize))) +
  geom_point(size = 2, alpha = 0.5) +
  geom_line(data = newdat_all %>% dplyr::group_by(Exp, curDur, WMSize, Gap) %>% dplyr::summarize(mmPred = mean(mPred), n = n(), se_mPred = sd(mPred)/sqrt(n-1)), aes(x = curDur, y = mmPred - curDur, group = interaction(WMSize, Gap), linetype = Gap, color = as.factor(WMSize))) +
  geom_hline(yintercept = 0, linetype = "dashed")+ scale_x_continuous(breaks=c(0.5, 0.8, 1.1, 1.4, 1.7)) +
  
  facet_grid(cols = vars(Exp)) +
  scale_color_grey(start = 0.2, end = 0.7) +
  scale_shape_manual(values = c(16, 1, 17, 2, 15, 0)) + 
  scale_linetype_manual(values = c("solid", "dotted")) +
  labs(x = " ", 
       y = paste0("Reproduction bias (s)   ", modelname), 
       shape = "Memory Load", 
       linetype = "Gap", 
       color = "Memory Load") +
  theme_new +
  theme(legend.position = "top")

RP_bias_bw
ggsave(paste0(getwd(), "/figures/RP_bias_bw_",modelname,".png"), RP_bias_bw, width = 8, height = 4)
```
## predicted CV


```{r plot predicted cv}
cv_newY <- newdat_all %>% 
  group_by(Exp, curDur, WMSize, Gap) %>%
  summarize(m_cv = mean(cv)) %>%
  arrange(Exp, WMSize, Gap, curDur)


RP_CV <- ggplot(data= mdat_all%>% 
  dplyr::group_by(Exp, curDur, WMSize, Gap) %>% 
  dplyr::summarize(m_predCV = mean(predCV)), 
                aes(x=curDur, y= m_predCV, group = interaction(Gap, WMSize),
                    color = as.factor(WMSize), shape = as.factor(WMSize))) +
  geom_point(size=2, alpha = 0.5)+
  geom_line(data = cv_newY, aes(x=curDur, y=m_cv, group = interaction(WMSize, Gap),
                linetype = Gap, color=WMSize)) +
  scale_x_continuous(breaks=c(0.5, 0.8, 1.1, 1.4, 1.7)) +
  facet_grid(~Exp) +
  labs(x="Durations (s)", y=paste0("Mean CV (s)", "   ", modelname), shape="Memory Load", linetype = "Gap", 
       color = "Memory Load") + theme_new + colorSet3 + 
  theme(legend.position = "top", 
        legend.title = element_text(size = 14, face = "bold"), 
        legend.text = element_text(size = 14), 
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 11),
        strip.text.x = element_blank(),
        plot.title = element_text(hjust = 0.5))
RP_CV
```



```{r plot combined predictions on bias cv and obs-pred correlation (Fig in Appendix)}
# plot color plots for Appendix
RP_bias <- ggplot(data = mdat_all%>% 
                         dplyr::group_by(Exp, curDur, WMSize, Gap) %>%dplyr::summarize(m_repDur = mean(repDur_mean),  n= n(), se_repDur_mean = sd(repDur_mean)/sqrt(n-1)), 
                       aes(x = curDur, y = m_repDur - curDur, group = interaction(Gap, WMSize), 
                           color=as.factor(WMSize), shape = as.factor(WMSize))) +
  geom_point(size=2, alpha = 0.5)+
  geom_line(data= newdat_all %>% dplyr::group_by(Exp, curDur, WMSize, Gap) %>% dplyr::summarize(mmPred = mean(mPred), n = n(), se_mPred = sd(mPred)/sqrt(n-1)), aes(x = curDur, y = mmPred - curDur, group = interaction(WMSize, Gap), 
                linetype = Gap, color=WMSize)) +
  scale_x_continuous(breaks=c(0.5, 0.8, 1.1, 1.4, 1.7)) +
  geom_hline(yintercept = 0, linetype='dashed')+
  facet_grid(cols = vars(Exp), labeller = labeller(Exp = Exp.labs.2lines)) +
  labs(x="Durations (s)", y=paste0("Mean bias (s)     ", modelname), shape ="Memory Load", linetype = "Gap", 
       color = "Memory Load")+
  theme_new + colorSet3 + theme(legend.position = "top", 
        legend.title = element_text(size = 14, face = "bold"), 
        legend.text = element_text(size = 14), 
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 11),
        strip.text.x = element_text(size = 12),
        plot.title = element_text(hjust = 0.5))
RP_bias
```

## correlations of bias

```{r plot correlations of bias}
# plot correlation coefficients r of observed and predicted bias
plt_corr_obs_pred <- ggplot(data = mdat_all, 
                        aes(x = repErr, y = predErr, color = as.factor(WMSize),
                            shape = as.factor(Gap))) +
  geom_point(size=1, alpha = 0.5) + 
  facet_grid(~Exp) + 
  labs(x="Observed Bias (s)", y=" Predicted Bias (s)", shape="Gap",
       color = "Memory Load") + theme_new + colorSet3 + 
  theme(legend.position = "top", 
        legend.title = element_text(size = 14, face = "bold"), 
        legend.text = element_text(size = 14), 
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 11),
        strip.text.x = element_blank(),
        plot.title = element_text(hjust = 0.5))
plt_corr_obs_pred

```
```{r}
## combine predicted bias and cv
fig_bias_cv <- ggarrange(RP_bias, RP_CV, plt_corr_obs_pred, common.legend = TRUE,
                         ncol=1, nrow=3, heights = c(1.1, 0.9, 0.9), 
                         labels = c("a", "b", "c"))
ggsave(paste0(getwd(), "/figures/fig_bias_cv_pred_", modelname,".png"),
       fig_bias_cv, width = 9, height = 9)
fig_bias_cv

```


## weight of prior

```{r}
plt_wp_Gap <- ggplot(
  data = ParaList %>%
    dplyr::group_by(Exp, WMSize, Gap) %>%
    dplyr::summarise(
      m_wp = mean(w_p),
      n = n(),
      se_wp = sd(w_p) / sqrt(n - 1)
    ),
  aes(
    x = Exp,
    y = m_wp,
    ymin = m_wp - se_wp,
    ymax = m_wp + se_wp,
    group = interaction(Exp, WMSize, Gap),
    color = factor(WMSize),         # FIX 1
    shape = factor(WMSize),         # FIX 2
    linetype = factor(Gap)          # FIX 3
  )
) +
  geom_line(position = position_dodge(width = 0.3)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(width = .3, position = position_dodge(width = .3)) +
  colorSet5 +
  labs(
    x = "",
    y = TeX("Weight of the prior $w_p$"),
    color = "Memory Load",
    shape = "Memory Load",
    linetype = "Gap"
  ) +
  theme_new+scale_x_discrete(guide = guide_axis(n.dodge = 1)) +
theme(axis.text.x = element_text(angle = 30, hjust = 1))+theme(legend.position = "top",
      legend.direction = "horizontal")
plt_wp_Gap

ggsave(paste0(getwd(), "/figures/plt_wp_",modelname,".png"), plt_wp_Gap, width = 7, height = 4)
```


```{r}
# ---  黑白配色 ---
colorSet5_bw <- list(
  scale_color_manual(values = c("black", "grey20", "grey45")),
  scale_linetype_manual(values = c("solid", "dotted"))
)

plt_wp_Gap_wb <- ggplot(
  data = ParaList %>%
    dplyr::group_by(Exp, WMSize, Gap) %>%
    dplyr::summarise(
      m_wp = mean(w_p),
      n = n(),
      se_wp = sd(w_p) / sqrt(n - 1),
      .groups = "drop"
    ),
  aes(
    x = Exp,
    y = m_wp,
    ymin = m_wp - se_wp,
    ymax = m_wp + se_wp,
    group = interaction(Exp, WMSize, Gap),
    color = factor(WMSize),      
    shape = factor(WMSize),
    linetype = factor(Gap)
  )
) +
  geom_line(position = position_dodge(width = 0.3)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(width = .3, position = position_dodge(width = .3)) +
  colorSet5_bw +        # ✔ 使用黑白配色
  scale_x_discrete(labels = exp_labels) +   
  labs(
    x = "",
    y = TeX("Weight of the prior $w_p$"),
    color = "Memory Load",
    shape = "Memory Load",
    linetype = "Gap"
  ) +
  theme_new+ theme(legend.position="top")+
  theme_new+scale_x_discrete(guide = guide_axis(n.dodge = 1)) +
theme(axis.text.x = element_text(angle = 30, hjust = 1))

plt_wp_Gap_wb
```



## predicted mean bias


```{r}
plt_pred_Bias_bw <-ggplot(data = mdat_all %>%dplyr::group_by(Exp, WMSize, Gap) %>% dplyr::summarise(mmPred = mean(mPred), mpredErr= mean(predErr), n= n(), se_predErr = sd(predErr)/sqrt(n-1)), aes(Exp, mpredErr*1000, ymin = 1000*(mpredErr - se_predErr), ymax = 1000*(mpredErr + se_predErr), group =interaction(Exp, WMSize, Gap), color = WMSize, linetype = Gap, shape = WMSize))+
  geom_line(stat = "identity", position = position_dodge(width = 0.3))+
  geom_point(stat = "identity",position = position_dodge(width = 0.3))+
  geom_errorbar(width=.3,  position = position_dodge(width = .3)) +
  scale_x_discrete(labels = exp_labels) + 
  colorSet5_bw+
  labs(x = "", y = TeX("Predicted mean bias (ms)"), color = 'Memory Load', shape = 'Memory Load', linetype= 'Gap') + theme(legend.position="top")+
  theme_new+scale_x_discrete(guide = guide_axis(n.dodge = 1)) +
theme(axis.text.x = element_text(angle = 30, hjust = 1))

plt_pred_Bias_bw
```

```{r}
plt_pred_Bias <-ggplot(data = mdat_all %>%dplyr::group_by(Exp, WMSize, Gap) %>% dplyr::summarise(mmPred = mean(mPred), mpredErr= mean(predErr), n= n(), se_predErr = sd(predErr)/sqrt(n-1)), aes(Exp, mpredErr*1000, ymin = 1000*(mpredErr - se_predErr), ymax = 1000*(mpredErr + se_predErr), group =interaction(Exp, WMSize, Gap), color = WMSize, linetype = Gap, shape = WMSize))+
  geom_line(stat = "identity", position = position_dodge(width = 0.3))+
  geom_point(stat = "identity",position = position_dodge(width = 0.3))+
  geom_errorbar(width=.3,  position = position_dodge(width = .3)) +
  scale_x_discrete(labels = exp_labels) + 
  colorSet5+
  labs(x = "", y = TeX("Predicted mean bias (ms)"), color = 'Memory Load', shape = 'Memory Load', linetype= 'Gap') + theme(legend.position="top")+
  theme_new+scale_x_discrete(guide = guide_axis(n.dodge = 1)) +
theme(axis.text.x = element_text(angle = 30, hjust = 1))

plt_pred_Bias 
```



```{r}
fig7_wb<-ggarrange(plt_wp_Gap_wb, plt_pred_Bias_bw, common.legend = TRUE, ncol=2, nrow=1,  labels = c("a", "b"))
ggsave(paste0(getwd(), "/figures/fig7_wb_",modelname,".png"), fig7_wb, width = 7, height = 4)
fig7_wb
```
```{r}
fig7<-ggarrange(plt_wp_Gap, plt_pred_Bias, common.legend = TRUE, ncol=2, nrow=1,  labels = c("a", "b"))
ggsave(paste0(getwd(), "/figures/fig7_",modelname,".png"), fig7, width = 7, height = 4)
fig7
```

